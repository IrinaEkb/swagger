"use strict";function Validator(e){if(!(this instanceof Validator))return new Validator(e);var r=this;this.customValidators={},this.swagger=e,e&&(e.validateModel=function(e,t,i,n){var a=this.allModels;this.definitions&&(a=this.definitions);var o=e;return isStringType(e)&&a[e]&&(o=a[e]),validate(e,t,o,a,i,n,r.customValidators)})}function getCustomValidators(e,r,t){return e&&t&&t[e]&&t[e][r]?t[e][r]:null}function getCustomValidatorsFromModel(e,r){return e&&e["x-validators"]&&e["x-validators"][r]?e["x-validators"][r]:null}function validate(e,r,t,i,n,a,o){if(i===!0&&void 0===n?(n=!0,i=void 0):i!==!1&&null!==i||(i=void 0),!r)return createReturnObject(new Error("Unable to validate an undefined value."));if(n!==!0&&isEmptyObject(r))return createReturnObject(new Error("Unable to validate an empty value."));if(!t)return createReturnObject(new Error("Unable to validate against an undefined model."));var l=typeof r,u=t.type||"object";if("object"!==l&&l!==u)return createReturnObject(new Error("Unable to validate a model with an type: "+l+", expected: "+u));var s,d=getMergedModel(t,i);if(d=getDiscriminatedModel(r,d,i),d.required&&d.required.length>0&&(s=validateRequiredFields(r,d.required,d.properties)))return createReturnObject(s);var f=validateSpec(e,r,d,i,n,a,o);return f?createReturnObject(f,d.id||e):createReturnObject()}function isEmptyObject(e){if("object"!=typeof e)return!1;if(Array.isArray(e))return!1;for(var r in e)if(e[r]!=e.constructor.prototype[r])return!1;return!0}function createReturnObject(e,r){var t={};return e?(t.valid=!1,e.message?(t.errorCount=1,t.errors=[e]):(t.errorCount=e.length,t.errors=e),t.GetErrorMessages=function(){var e=[];for(var r in this.errors)e.push(this.errors[r].message);return e},t.GetFormattedErrors=function(){var e=[];for(var r in this.errors){var t=JSON.stringify(this.errors[r],["message","arguments","type","name"]);e.push(JSON.parse(t))}return e}):(t.valid=!0,t.errorCount=0),r&&(t.modelName=r),t}function validateProperties(e,r,t){var i=Object.keys(e),n=[],a=getRefedModel(r,t);if(a=getDiscriminatedModel(e,a,t),i)for(var o in i)a.properties[i[o]]||n.push(new Error("Target property '"+i[o]+"' is not in the model"));return n.length>0?n:null}function validateSpec(e,r,t,i,n,a,o){var l=t.properties,u=[];if(t.$ref){var s=validateType(e,r,t,i,n,a);s.valid||(u=s.errors)}else if(l){if(a&&!Array.isArray(r)&&(u=validateProperties(r,t,i)||[],t.discriminator&&u.length>=1))if(1==u.length&&u[0].message=="Target property '"+t.discriminator+"' is not in the model")u=[];else{var d=u;u=[],d.forEach(function(e){e.message!="Target property '"+t.discriminator+"' is not in the model"&&u.push(e)})}for(var f in l){var c=l[f],v=r[f];if(void 0!==v){var m=validateValue(f,c,v,i,n,a);m||(m=validateCustom(t.id||e,f,v,o)),m||(m=validateCustomFromModel(t,f,v)),m&&m.forEach(function(e){u.push(e)})}}}else{if(!t.type)return null;var p=validateValue(e,t,r,i);p&&p.forEach(function(e){u.push(e)})}return u.length>0?u:null}function validateCustomFromModel(e,r,t){var i=getCustomValidatorsFromModel(e,r);if(!i)return null;var n=[];return i.forEach(function(e){try{var i=e(r,t);i&&(i.message?n.push(i):i.forEach(function(e){n.push(e)}))}catch(a){console.warn(error)}}),n.length>0?n:null}function validateCustom(e,r,t,i){var n=getCustomValidators(e,r,i);if(!n)return null;var a=[];return n.forEach(function(e){try{var i=e(r,t);i&&(i.message?a.push(i):i.forEach(function(e){a.push(e)}))}catch(n){console.warn(error)}}),a.length>0?a:null}function validateValue(e,r,t,i,n,a){var o=[];if(void 0!==t){var l=validateType(e,t,r,i,n,a);if(l)return void 0===l.valid?(o.push(l),o):l.valid?null:(l.errors.forEach(function(e){o.push(e)}),o);if("string"===r["x-validatedType"]&&(r.minLength>0||r.maxLength>0)){var u=validateMinMaxLength(e,t,r.minLength,r.maxLength);u&&o.push(u)}if("integer"===r.type||"number"===r.type||"date"===r["x-validatedType"]||"date-time"===r["x-validatedType"]){if(r.minimum||r.maximum||0===r.minimum||0===r.maximum){var s=validateMinMaxValue(e,t,r.minimum,r.maximum);s&&o.push(s)}if(r.exclusiveMinimum||r.exclusiveMaximum){var d,f;(r.exclusiveMinimum||0===r.exclusiveMinimum)&&(d=r.exclusiveMinimum+1),(r.exclusiveMaximum||0===r.exclusiveMaximum)&&(f=r.exclusiveMaximum-1),"date"===r["x-validatedType"]||"date-time"===r["x-validatedType"]?(r.exclusiveMinimum&&(d=incrementDateString(r.exclusiveMinimum,1)),r.exclusiveMaximum&&(f=incrementDateString(r.exclusiveMaximum,-1)),t=new Date(t).toISOString()):"number"!==r.type&&"float"!==r["x-validatedType"]&&"double"!==r["x-validatedType"]||(r.exclusiveMinimum&&(d=r.exclusiveMinimum+1e-11),r.exclusiveMaximum&&(f=r.exclusiveMaximum-1e-11));var c=validateMinMaxValue(e,t,d,f,!0);c&&o.push(c)}}if("byte"===r["x-validatedType"],r["enum"]){var v=validateEnums(e,t,r["enum"]);v&&o.push(v)}}return o.length>0?o:null}function validateType(e,r,t,i,n,a){var o=t.type;if(!o){if(i&&t.$ref){var l=t.$ref.replace("#/definitions/","");return validate(e,r,i[l],i,n,a)}return null}if(o=o.toLowerCase(),"object"===o)return t.properties?validate(e,r,t,i,n,a):null;if("array"===o){if(!Array.isArray(r))return new Error(e+" is not an array. An array is expected.");if(t.items&&t.items.type){var u=t.items.type,s=0,d=[];if(r.forEach(function(r){var o=validateValue(e+s.toString(),t.items,r,i,n,a);o&&o.forEach(function(e){d.push(e)}),s+=1}),d.length>0)return createReturnObject(d,"Array of "+u+" ("+e+")")}else if(i&&t.items&&t.items.$ref){var f=t.items.$ref.replace("#/definitions/",""),c=i[f];if(c){var v=[];if(r.forEach(function(r){var t=validate(e,r,c,i,n,a);t&&!t.valid&&t.errors.forEach(function(e){v.push(e)})}),v.length>0)return createReturnObject(v,"Array of "+t.items.$ref+" ("+e+")")}}return null}var m=t.format;if(m&&(m=m.toLowerCase()),void 0===r||null===r)return null;if("string"===o){if(isStringType(r,m))return t["x-validatedType"]=m||o,null}else if("boolean"===o){if(isExpectedType(r,o))return t["x-validatedType"]=m||o,null}else if("integer"===o){if(isIntegerType(r,m))return t["x-validatedType"]=m||o,null}else if("number"===o&&isNumberType(r,m))return t["x-validatedType"]=m||o,null;return new Error(e+" ("+wrapNullProperty(r)+") is not a type of "+(m||o))}function isStringType(e,r){if(isExpectedType(e,"string")){if(!r)return!0;if("date"!==r&&"date-time"!==r)return!0;var t=new Date(e);if("Invalid Date"!==t&&!isNaN(t)&&isNaN(e))return!("date"===r&&10!==e.length)}return!1}function isIntegerType(e,r){if(!isNumberType(e))return!1;if(!r)return!0;if("int32"===r){var t=Math.pow(2,31)-1,i=parseInt(e);if(!isNaN(i)&&isFinite(e)&&i>=-(t+1)&&i<=t)return!0}else{if("int64"!==r)return!0;var n=parseInt(e);if(!isNaN(n)&&isFinite(e))return!0}return!1}function isNumberType(e,r){return!(!r||"float"===r||"double"===r)||!(isNaN(parseFloat(e))||!isFinite(e))}function isExpectedType(e,r){return typeof e===r}function wrapNullProperty(e){return null===e?"{null}":""===e?"{empty string}":e}function validateMinLength(e,r,t){return t>0&&r.length<t?1===t?new Error(e+" cannot be blank"):new Error(e+" must be at least "+t.toString()+" characters long"):null}function validateMaxLength(e,r,t){return t>0&&r.length>t?new Error(e+" must be no more than "+t.toString()+" characters long"):null}function validateMinMaxLength(e,r,t,i){return t||i?t?i?r.length<t||r.length>i?1===t?new Error(e+" cannot be blank and cannot be longer than "+i.toString()+" characters long"):new Error(e+" must be at least "+t.toString()+" characters long and no more than "+i.toString()+" characters long"):null:validateMinLength(e,r,t):validateMaxLength(e,r,i):null}function validateMinValue(e,r,t){return(t||0===t)&&r<t?new Error(e+" must be at least "+t.toString()):null}function validateMaxValue(e,r,t){return(t||0===t)&&r>t?new Error(e+" must be no more than "+t.toString()):null}function validateMinMaxValue(e,r,t,i,n){return t||i||0!==!t||0!==!t?void 0===t?validateMaxValue(e,r,i):void 0===i?validateMinValue(e,r,t):r<t||r>i?new Error(e+" must be at least "+t.toString()+" and no more than "+i.toString()):null:null}function validateRequiredFields(e,r,t){if(!(r instanceof Array))throw new Error("fields must be an array of required fields");for(var i=[],n=0;n<r.length;++n){var a=r[n];try{e.hasOwnProperty(a)&&""!==e[a]&&(null!==e[a]||t[a]["x-nullable"])||i.push(new Error(a+" is a required field"))}catch(o){i.push(new Error("object does not have property "+a))}}return i.length>0?i:null}function validateEnums(e,r,t){if(void 0===r||null===r)return null;for(var i in t)if(r===t[i])return null;return new Error(e+" is not set to an allowed value (see enum)")}function incrementDateString(e,r){var t=new Date(e);return t.setMilliseconds(t.getMilliseconds()+r),t.toISOString()}function merge(e,r){if("undefined"==typeof r)return e;if("undefined"==typeof e)return r;"object"!=typeof e&&(e={});for(var t in r)if(r.hasOwnProperty(t)){var i=r[t];Array.isArray(i)?"undefined"==typeof e[t]?e[t]=i:e[t]=e[t].concat(i):"object"==typeof i?(e[t]||(e[t]={}),e[t]=merge(e[t],i)):e[t]=i}for(var n=2,a=arguments.length;n<a;n++)merge(e,arguments[n]);return e}function getDiscriminatedModel(e,r,t){var i=r.discriminator&&e[r.discriminator];if(i&&t[i]){var n=r.discriminator;r=t[i],r=getMergedModel(r,t),r.discriminator=n}return r}function getMergedModel(e,r){if(e.allOf){var t=merge({},e);return delete t.allOf,e.allOf.forEach(function(e){if(e.$ref){var i=r[e.$ref.replace("#/definitions/","")];i.allOf&&(i=getMergedModel(i,r)),t=merge(t,i)}else t=merge(t,e)}),t}return e}function getRefedModel(e,r){if(e.properties){var t=merge({},e),i=Object.keys(e.properties);for(var n in i){var a=t.properties[i[n]];if(a&&a.$ref){var o=a.$ref;delete a.$ref;var l=r[o.replace("#/definitions/","")];l&&(l.allOf&&(l=getMergedModel(l,r)),l=getRefedModel(l,r),t.properties[i[n]]=merge(a,l))}}}return t}exports=Validator,module.exports=exports=Validator,Validator.prototype.validate=function(e,r,t,i,n){return validate("rootModel",e,r,t,i,n,this.customValidators)},Validator.prototype.addFieldValidatorToModel=function(e,r,t){if(!e)throw new Error("Model is required");if("object"!=typeof e)throw new error("Model must be an object");if(!r)throw new Error("FieldName is required");if("string"!=typeof r)throw new Error("FieldName must be a string");if(!t)throw new Error("ValidatorFunction is required");if("function"!=typeof t)throw new Error("ValidatorFunction is not a function");e.id&&this.addFieldValidator(e.id,r,t);var i=e["x-validators"];if(i){var n=i[r];return n?(n.push(t),!0):(n=[t],i[r]=n,!0)}return i={},i[r]=[t],e["x-validators"]=i,!0},Validator.prototype.addFieldValidator=function(e,r,t){if(!e)throw new Error("ModelName is required");if("string"!=typeof e)throw new Error("ModelName must be a string");if(!r)throw new Error("FieldName is required");if("string"!=typeof r)throw new Error("FieldName must be a string");if(!t)throw new Error("ValidatorFunction is required");if("function"!=typeof t)throw new Error("ValidatorFunction is not a function");var i=this.customValidators[e];if(i){var n=i[r];return n?(n.push(t),!0):(n=[t],i[r]=n,!0)}return i={},i[r]=[t],this.customValidators[e]=i,!0},Validator.prototype.getFieldValidators=function(e,r){return getCustomValidators(e,r,this.customValidators)};